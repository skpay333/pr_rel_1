import{r as a,j as e}from"./react-vendor-DXh2JWUH.js";import{C as d,B as i}from"./card-l8B5EJfV.js";import{A as X,d as Y,e as Z,D as U,h as A,a as k,b as B,c as E,g as _}from"./avatar-nL0TpwiJ.js";import{B as ee}from"./badge-Dedo9uIt.js";import{S as se}from"./scroll-area-Ccv5Za3h.js";import{I as O}from"./input-BK4KRhIb.js";import{u as te,D as ae,d as f,E as re,F as le}from"./index-XvOZlhht.js";import{U as de,q as ne,b as F,G as ie,i as oe,r as ce}from"./icons-vendor-BKMeapAd.js";import"./ui-extended-CLSNRB24.js";import"./ui-core-DuOrk3UI.js";import"./utils-vendor-B2rm_Apj.js";import"./react-query-DV86JtqI.js";function ye({username:m,registeredAt:W,notifications:r,onClearData:I,onMarkNotificationRead:N,userId:l,referrerId:xe,avatarUrl:b}){const[L,M]=a.useState(!1),[$,u]=a.useState(!1),v=a.useRef(new Set),{toast:h}=te(),[t,z]=a.useState(null),[o,w]=a.useState(""),[P,C]=a.useState(!1),[y,D]=a.useState(!1),[g,R]=a.useState(!1),[S,c]=a.useState(null),[G,x]=a.useState(null),q=new Date(W).toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"}),T=r.filter(s=>!s.isRead).length,H=r.slice(0,2),J=r.length>2;a.useEffect(()=>{if(r.length===0)return;r.filter(n=>!n.isRead).slice(0,2).forEach(n=>{v.current.has(n.id)||(v.current.add(n.id),N(n.id))})},[r,N]),a.useEffect(()=>{l&&p()},[l]);const p=async()=>{if(l){C(!0);try{const s=await ae(l);z(s)}catch(s){console.error("Failed to load referral stats:",s),h({title:"Ошибка",description:"Не удалось загрузить реферальную статистику",variant:"destructive"})}finally{C(!1)}}},K=()=>{t!=null&&t.promoCode&&(navigator.clipboard.writeText(t.promoCode),h({title:"Промокод скопирован",description:`Код ${t.promoCode} скопирован в буфер обмена`}))},Q=async()=>{var s;if(c(null),x(null),!l||!o.trim()){c("Введите промокод"),x("error");return}if(o.trim().toUpperCase()===((s=t==null?void 0:t.promoCode)==null?void 0:s.toUpperCase())){c("Нельзя использовать свой промокод"),x("error");return}D(!0);try{await re(l,o.trim()),c("Ваш бонус успешно зачислен на баланс"),x("success"),w(""),await p()}catch(j){const n=j instanceof Error?j.message:"Не удалось активировать промокод";c(n),x("error")}finally{D(!1)}},V=async()=>{if(l){R(!0);try{const s=await le(l);h({title:"Успешно!",description:"Средства переведены на основной баланс"}),u(!1),await p()}catch(s){h({title:"Ошибка",description:s instanceof Error?s.message:"Не удалось вывести средства",variant:"destructive"})}finally{R(!1)}}};return e.jsx("div",{className:"flex flex-col min-h-[calc(100vh-4rem)] px-6 pt-8 pb-28 bg-background",children:e.jsxs("div",{className:"max-w-md w-full mx-auto space-y-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Настройки"}),e.jsxs(d,{className:"p-6 shadow-soft",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsxs(X,{className:"w-20 h-20 shadow-soft-sm",children:[b&&e.jsx(Y,{src:b,alt:m}),e.jsx(Z,{className:"bg-accent text-white text-2xl font-bold",children:m.slice(0,2).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-foreground","data-testid":"text-username",children:m}),e.jsxs("p",{className:"text-sm text-muted-foreground font-medium","data-testid":"text-registered-date",children:["Дата регистрации: ",q]})]})]}),e.jsx("div",{className:"space-y-3 pt-5 border-t border-border",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(de,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground font-medium",children:"Имя в Telegram:"}),e.jsxs("span",{className:"text-foreground font-bold",children:["@",m]})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-foreground"}),e.jsx("h2",{className:"text-xl font-bold text-foreground",children:"История уведомлений"})]}),T>0&&e.jsx(ee,{className:"bg-red-500 text-white","data-testid":"badge-unread-count",children:T})]}),r.length===0?e.jsx(d,{className:"p-8 shadow-soft",children:e.jsx("p",{className:"text-center text-muted-foreground font-medium",children:"Нет уведомлений"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3",children:H.map(s=>e.jsx(d,{className:`p-4 shadow-soft ${s.isRead?"bg-card":"bg-blue-50 border-blue-200"}`,"data-testid":`notification-${s.id}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(F,{className:"w-5 h-5 text-green-600 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s.message}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(s.createdAt).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})})]})]})},s.id))}),J&&e.jsxs(U,{open:L,onOpenChange:M,children:[e.jsx(A,{asChild:!0,children:e.jsxs(i,{variant:"outline",size:"sm",className:"w-full text-muted-foreground hover:text-foreground","data-testid":"button-all-notifications",children:["Все уведомления (",r.length,")"]})}),e.jsxs(k,{className:"max-w-md",children:[e.jsx(B,{children:e.jsx(E,{className:"text-xl font-bold",children:"Все уведомления"})}),e.jsx(se,{className:"max-h-[60vh] pr-4",children:e.jsx("div",{className:"space-y-3",children:r.map(s=>e.jsx(d,{className:`p-4 shadow-soft ${s.isRead?"bg-card":"bg-blue-50 border-blue-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(F,{className:"w-5 h-5 text-green-600 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s.message}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(s.createdAt).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})})]})]})},s.id))})})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5 text-foreground"}),e.jsx("h2",{className:"text-xl font-bold text-foreground",children:"Реферальная программа"})]}),P?e.jsx(d,{className:"p-8 shadow-soft",children:e.jsx("p",{className:"text-center text-muted-foreground font-medium",children:"Загрузка..."})}):t?e.jsxs(e.Fragment,{children:[e.jsxs(d,{className:"p-5 shadow-soft",children:[e.jsx("p",{className:"text-sm font-semibold text-muted-foreground mb-2",children:"Ваш промокод"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:t.promoCode||"",readOnly:!0,className:"font-mono font-bold text-lg"}),e.jsx(i,{variant:"outline",size:"icon",onClick:K,className:"shrink-0",disabled:!t.promoCode,children:e.jsx(oe,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Пригласите друзей и получайте 0.5% от суммы всех их платежей"})]}),t.referrerId===null&&e.jsxs(d,{className:"p-5 shadow-soft",children:[e.jsx("p",{className:"text-sm font-semibold text-muted-foreground mb-3",children:"Активировать промокод"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{placeholder:"Введите промокод",value:o,onChange:s=>w(s.target.value)}),e.jsx(i,{onClick:Q,disabled:y||!o.trim(),className:"shrink-0",children:y?"...":"Активировать"})]}),S&&e.jsx("div",{className:`mt-3 p-3 rounded-lg ${G==="success"?"bg-green-50 border border-green-200 text-green-800":"bg-red-50 border border-red-200 text-red-800"}`,children:e.jsx("p",{className:"text-sm font-medium",children:S})})]}),e.jsxs(d,{className:"p-5 shadow-soft",children:[e.jsx("p",{className:"text-sm font-semibold text-muted-foreground mb-4",children:"Статистика"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Рефералов"}),e.jsx("p",{className:"text-xl font-bold text-foreground",children:t.referralsCount})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Баланс"}),e.jsxs("p",{className:"text-xl font-bold text-primary",children:[f(t.referralBalance)," USDT"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Заработано"}),e.jsxs("p",{className:"text-lg font-semibold text-foreground",children:[f(t.referralTotalEarned)," USDT"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Выведено"}),e.jsxs("p",{className:"text-lg font-semibold text-foreground",children:[f(t.referralTotalWithdrawn)," USDT"]})]})]})]}),t.referralBalance>=50&&e.jsxs(U,{open:$,onOpenChange:u,children:[e.jsx(A,{asChild:!0,children:e.jsx(i,{className:"w-full font-bold",size:"lg",children:"Вывести на основной баланс"})}),e.jsxs(k,{className:"max-w-sm",children:[e.jsx(B,{children:e.jsx(E,{className:"text-xl font-bold",children:"Подтверждение вывода"})}),e.jsxs("div",{className:"py-4",children:[e.jsx("p",{className:"text-center text-muted-foreground mb-2",children:"Вы выводите:"}),e.jsxs("p",{className:"text-center text-3xl font-bold text-primary",children:[f(t.referralBalance)," USDT"]}),e.jsx("p",{className:"text-center text-sm text-muted-foreground mt-4",children:"Средства будут зачислены на основной баланс"})]}),e.jsxs(_,{className:"flex gap-2",children:[e.jsx(i,{variant:"outline",onClick:()=>u(!1),disabled:g,className:"flex-1",children:"Отмена"}),e.jsx(i,{onClick:V,disabled:g,className:"flex-1",children:g?"...":"Подтвердить"})]})]})]})]}):null]}),e.jsxs(i,{variant:"outline",className:"w-full justify-center gap-2 min-h-[52px] text-destructive hover:text-destructive rounded-lg font-bold",onClick:I,"data-testid":"button-clear-data",children:[e.jsx(ce,{className:"w-5 h-5"}),"Очистить данные"]}),e.jsx("p",{className:"text-xs text-center text-muted-foreground font-medium",style:{opacity:.6},children:"Romax Pay beta 1"})]})})}export{ye as default};
