const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AdminPanel-BZFFnKwy.js","assets/react-vendor-DXh2JWUH.js","assets/card-l8B5EJfV.js","assets/ui-extended-CLSNRB24.js","assets/ui-core-DuOrk3UI.js","assets/utils-vendor-B2rm_Apj.js","assets/input-BK4KRhIb.js","assets/tabs-T0-tMZ9B.js","assets/avatar-nL0TpwiJ.js","assets/icons-vendor-BKMeapAd.js","assets/alert-dialog-B07NitoX.js","assets/label-CgwsQBad.js","assets/PaymentDetailsDialog-B7E2mNGi.js","assets/badge-Dedo9uIt.js","assets/scroll-area-Ccv5Za3h.js","assets/react-query-DV86JtqI.js","assets/OperatorPanel-mHP4zKrz.js","assets/textarea-CiUoc1B0.js","assets/DashboardPage-CnCHBoz7.js","assets/TopUpPage-TYjv8a08.js","assets/PayPage-Wo8f9hdt.js","assets/HistoryPage-C03dUUtV.js","assets/RequestDetailPage-D9ulRrkR.js","assets/InstructionsPage-CFGO8lRA.js","assets/SettingsPage-DyPAnyyJ.js"])))=>i.map(i=>d[i]);
import{a as Qe,r as i,j as s}from"./react-vendor-DXh2JWUH.js";import{Q as We,a as W}from"./react-query-DV86JtqI.js";import{V as pe,m as me,A as he,n as ye,o as we,p as ge,q as Ze,r as xe,s as Xe}from"./ui-core-DuOrk3UI.js";import{t as Ke,c as Ye,a as et}from"./utils-vendor-B2rm_Apj.js";import{X as tt,H as ot,C as rt,B as st,S as nt,Z as je}from"./icons-vendor-BKMeapAd.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const p of n)if(p.type==="childList")for(const h of p.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function o(n){const p={};return n.integrity&&(p.integrity=n.integrity),n.referrerPolicy&&(p.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?p.credentials="include":n.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function r(n){if(n.ep)return;n.ep=!0;const p=o(n);fetch(n.href,p)}})();var be,de=Qe;be=de.createRoot,de.hydrateRoot;const at="modulepreload",it=function(t){return"/"+t},ue={},v=function(e,o,r){let n=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const h=document.querySelector("meta[property=csp-nonce]"),m=(h==null?void 0:h.nonce)||(h==null?void 0:h.getAttribute("nonce"));n=Promise.allSettled(o.map(j=>{if(j=it(j),j in ue)return;ue[j]=!0;const x=j.endsWith(".css"),T=x?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${j}"]${T}`))return;const b=document.createElement("link");if(b.rel=x?"stylesheet":at,x||(b.as="script"),b.crossOrigin="",b.href=j,m&&b.setAttribute("nonce",m),document.head.appendChild(b),x)return new Promise((O,N)=>{b.addEventListener("load",O),b.addEventListener("error",()=>N(new Error(`Unable to preload CSS for ${j}`)))})}))}function p(h){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=h,window.dispatchEvent(m),!m.defaultPrevented)throw h}return n.then(h=>{for(const m of h||[])m.status==="rejected"&&p(m.reason);return e().catch(p)})};async function ct(t){if(!t.ok){const e=await t.text()||t.statusText;throw new Error(`${t.status}: ${e}`)}}const lt=({on401:t})=>async({queryKey:e})=>{const o=await fetch(e.join("/"),{credentials:"include"});return await ct(o),await o.json()},Z=new We({defaultOptions:{queries:{queryFn:lt({on401:"throw"}),refetchInterval:!1,refetchOnWindowFocus:!1,staleTime:1/0,retry:!1},mutations:{retry:!1}}}),dt=1,ut=1e6;let X=0;function ft(){return X=(X+1)%Number.MAX_SAFE_INTEGER,X.toString()}const K=new Map,fe=t=>{if(K.has(t))return;const e=setTimeout(()=>{K.delete(t),P({type:"REMOVE_TOAST",toastId:t})},ut);K.set(t,e)},pt=(t,e)=>{switch(e.type){case"ADD_TOAST":return{...t,toasts:[e.toast,...t.toasts].slice(0,dt)};case"UPDATE_TOAST":return{...t,toasts:t.toasts.map(o=>o.id===e.toast.id?{...o,...e.toast}:o)};case"DISMISS_TOAST":{const{toastId:o}=e;return o?fe(o):t.toasts.forEach(r=>{fe(r.id)}),{...t,toasts:t.toasts.map(r=>r.id===o||o===void 0?{...r,open:!1}:r)}}case"REMOVE_TOAST":return e.toastId===void 0?{...t,toasts:[]}:{...t,toasts:t.toasts.filter(o=>o.id!==e.toastId)}}},B=[];let I={toasts:[]};function P(t){I=pt(I,t),B.forEach(e=>{e(I)})}function mt({...t}){const e=ft(),o=n=>P({type:"UPDATE_TOAST",toast:{...n,id:e}}),r=()=>P({type:"DISMISS_TOAST",toastId:e});return P({type:"ADD_TOAST",toast:{...t,id:e,open:!0,onOpenChange:n=>{n||r()}}}),{id:e,dismiss:r,update:o}}function ht(){const[t,e]=i.useState(I);return i.useEffect(()=>(B.push(e),()=>{const o=B.indexOf(e);o>-1&&B.splice(o,1)}),[t]),{...t,toast:mt,dismiss:o=>P({type:"DISMISS_TOAST",toastId:o})}}function A(...t){return Ke(Ye(t))}function Jt(t){const e=typeof t=="bigint"?yt(t):Number(t);return isNaN(e)?"0.00":e.toFixed(2)}function Ht(t){const e=Number(t);return isNaN(e)?"0":e.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g," ")}function yt(t){return Number(t)/1e8}function Mt(t){return t?new Date(t).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",timeZone:"Europe/Moscow"})+" МСК":"-"}function Gt(t){if(t==null)return"0.00";const e=Number(t);if(isNaN(e))return"0.00";const r=e.toFixed(8).replace(/\.?0+$/,"");if(r.indexOf(".")===-1)return r+".00";const[,n]=r.split(".");return!n||n.length<2?e.toFixed(2):r}const wt=Ze,ve=i.forwardRef(({className:t,...e},o)=>s.jsx(pe,{ref:o,className:A("fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",t),...e}));ve.displayName=pe.displayName;const gt=et("group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",{variants:{variant:{default:"border bg-background text-foreground",destructive:"destructive group border-destructive bg-destructive text-destructive-foreground"}},defaultVariants:{variant:"default"}}),Te=i.forwardRef(({className:t,variant:e,...o},r)=>s.jsx(me,{ref:r,className:A(gt({variant:e}),t),...o}));Te.displayName=me.displayName;const xt=i.forwardRef(({className:t,...e},o)=>s.jsx(he,{ref:o,className:A("inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",t),...e}));xt.displayName=he.displayName;const Se=i.forwardRef(({className:t,...e},o)=>s.jsx(ye,{ref:o,className:A("absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",t),"toast-close":"",...e,children:s.jsx(tt,{className:"h-4 w-4"})}));Se.displayName=ye.displayName;const Ee=i.forwardRef(({className:t,...e},o)=>s.jsx(we,{ref:o,className:A("text-sm font-semibold",t),...e}));Ee.displayName=we.displayName;const Ae=i.forwardRef(({className:t,...e},o)=>s.jsx(ge,{ref:o,className:A("text-sm opacity-90",t),...e}));Ae.displayName=ge.displayName;function Y(){const{toasts:t}=ht();return s.jsxs(wt,{children:[t.map(function({id:e,title:o,description:r,action:n,...p}){return s.jsxs(Te,{...p,children:[s.jsxs("div",{className:"grid gap-1",children:[o&&s.jsx(Ee,{children:o}),r&&s.jsx(Ae,{children:r})]}),n,s.jsx(Se,{})]},e)}),s.jsx(ve,{})]})}const ee=Xe,jt=i.forwardRef(({className:t,sideOffset:e=4,...o},r)=>s.jsx(xe,{ref:r,sideOffset:e,className:A("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",t),...o}));jt.displayName=xe.displayName;const f="/api";async function te(t,e,o){const r=await fetch(`${f}/user/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({initData:o,telegramId:t,username:e})});if(!r.ok){const n=await r.json();throw new Error(n.error||"Failed to authenticate user")}return r.json()}async function oe(t){const e=await fetch(`${f}/user/${t}/balance`);if(e.status===304)return null;if(!e.ok)throw new Error(`Failed to fetch balance: ${e.status} ${e.statusText}`);return e.json()}async function bt(t){const e=await fetch(`${f}/payments/user/${t}`);if(!e.ok)throw new Error("Failed to fetch payment requests");return e.json()}async function vt(t){const e=await fetch(`${f}/payments/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const o=await e.json();throw new Error(o.error||"Failed to create payment request")}return e.json()}async function Tt(t,e){const o=await fetch(`${f}/payments/${t}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:e})});if(!o.ok)throw new Error("Failed to update payment request");return o.json()}async function R(t){const e=await fetch(`${f}/notifications/user/${t}`);if(!e.ok)throw new Error("Failed to fetch notifications");return e.json()}async function St(t){const e=await fetch(`${f}/notifications/${t}/read`,{method:"PATCH"});if(!e.ok)throw new Error("Failed to mark notification as read");return e.json()}async function Et(){const t=await fetch(`${f}/exchange-rate`);if(t.status===304)return null;if(!t.ok)throw new Error(`Failed to fetch exchange rate: ${t.status} ${t.statusText}`);return t.json()}async function Qt(t){const e=await fetch(`${f}/admin/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})});if(!e.ok){const o=await e.json();throw new Error(o.error||"Login failed")}return e.json()}async function Wt(t){const e=await fetch(`${f}/admin/users?password=${encodeURIComponent(t)}`);if(!e.ok)throw new Error("Failed to fetch users");return e.json()}async function Zt(t,e){const o=e?{...e}:{},r=new URLSearchParams({password:t});o.status&&r.append("status",o.status),o.userId&&r.append("userId",o.userId),o.urgency&&r.append("urgency",o.urgency);const n=await fetch(`${f}/admin/payments?${r.toString()}`);if(!n.ok)throw new Error("Failed to fetch payment requests");return n.json()}async function Xt(t,e,o,r){const n=await fetch(`${f}/admin/user/${e}/balance`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,availableBalance:o,frozenBalance:r})});if(!n.ok){const p=await n.json();throw new Error(p.error||"Failed to update balance")}return n.json()}async function Kt(t,e,o){const r=await fetch(`${f}/admin/user/${e}/deposit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,amount:o})});if(!r.ok){const n=await r.json();throw new Error(n.error||"Failed to add deposit")}return r.json()}async function Yt(t,e){const o=await fetch(`${f}/admin/payment/${e}/cancel`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})});if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to cancel payment")}return o.json()}async function eo(t,e){const o=await fetch(`${f}/deposits/create-automated`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,requestedAmount:e})});if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to create automated deposit")}return o.json()}async function At(t){const e=await fetch(`${f}/deposits/user/${t}`);if(!e.ok)throw new Error("Failed to fetch deposits");return e.json()}async function to(t){const e=await fetch(`${f}/deposits/${t}/cancel`,{method:"POST",credentials:"include"});if(!e.ok){const o=await e.json();throw new Error(o.error||"Failed to cancel deposit")}return e.json()}async function oo(t){const e=await fetch(`${f}/admin/deposits/pending?password=${encodeURIComponent(t)}`);if(!e.ok)throw new Error("Failed to fetch pending deposits");return e.json()}async function ro(t,e="all"){const o=new URLSearchParams({password:t});e&&e!=="all"&&o.append("status",e);const r=await fetch(`${f}/admin/deposits/all?${o.toString()}`);if(!r.ok)throw new Error("Failed to fetch all deposits");return r.json()}async function so(t,e){const o=await fetch(`${f}/admin/deposits/${e}/confirm`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})});if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to confirm deposit")}return o.json()}async function no(t,e,o,r){const n=await fetch(`${f}/admin/deposits/${e}/manual-confirm`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,actualAmount:o,txHash:r})});if(!n.ok){const p=await n.json();throw new Error(p.error||"Failed to manually confirm deposit")}return n.json()}async function ao(t,e){const o=await fetch(`${f}/admin/deposits/${e}/reject`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})});if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to reject deposit")}return o.json()}async function io(t,e){const o=await fetch(`${f}/admin/deposits/${e}/details?password=${encodeURIComponent(t)}`);if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to fetch deposit details")}return o.json()}async function co(t,e,o,r,n,p){const h=await fetch(`${f}/admin/payments/${e}/process`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,status:o,receipt:r,adminComment:n,newAmountRub:p})});if(!h.ok){const m=await h.json();throw new Error(m.error||"Failed to process payment")}return h.json()}async function lo(t,e){const o=await fetch(`${f}/admin/payments/${e}?password=${encodeURIComponent(t)}`);if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to fetch payment details")}return o.json()}async function uo(t,e){const o=await fetch(`${f}/operator/${t}/payments/${e}`);if(!o.ok){const r=await o.json();throw new Error(r.message||"Failed to fetch payment details")}return o.json()}async function fo(t){const e=await fetch(`${f}/admin/operators?password=${encodeURIComponent(t)}`);if(!e.ok)throw new Error("Failed to fetch operators");return e.json()}async function po(t,e,o){const r=await fetch(`${f}/admin/operators`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,login:e,operatorPassword:o})});if(!r.ok){const n=await r.json();throw new Error(n.error||"Failed to create operator")}return r.json()}async function mo(t,e,o){const r=await fetch(`${f}/admin/operators/${e}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t,isActive:o})});if(!r.ok)throw new Error("Failed to update operator status");return r.json()}async function ho(t,e){const o=await fetch(`${f}/admin/operators/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})});if(!o.ok)throw new Error("Failed to delete operator");return o.json()}async function yo(t){const e=await fetch(`${f}/referral/stats/${t}`);if(!e.ok){const o=await e.json();throw new Error(o.error||"Failed to fetch referral statistics")}return e.json()}async function wo(t,e){const o=await fetch(`${f}/referral/activate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,promoCode:e})});if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to activate referral code")}return o.json()}async function go(t){const e=await fetch(`${f}/referral/withdraw`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t})});if(!e.ok){const o=await e.json();throw new Error(o.error||"Failed to withdraw referral balance")}return e.json()}async function xo(t,e){const o=await fetch(`${f}/admin/users/${e}/stats?password=${encodeURIComponent(t)}`);if(!o.ok){const r=await o.json();throw new Error(r.error||"Failed to fetch user statistics")}return o.json()}function Nt({activeTab:t,onTabChange:e,unreadCount:o=0}){const r=[{id:"home",label:"Главная",icon:ot},{id:"history",label:"История",icon:rt},{id:"instructions",label:"Инструкции",icon:st},{id:"settings",label:"Настройки",icon:nt}];return s.jsx("nav",{className:"fixed bottom-0 left-0 right-0 bg-[#FFFFFF] border-t border-border shadow-soft z-50",children:s.jsx("div",{className:"max-w-md mx-auto",children:s.jsx("div",{className:"grid grid-cols-4 h-20 safe-area-inset-bottom",children:r.map(({id:n,label:p,icon:h})=>{const m=t===n;return s.jsxs("button",{onClick:()=>e(n),className:`
                  flex flex-col items-center justify-center gap-1 h-full cursor-pointer
                  transition-colors relative
                  ${m?"text-[#0B3D4A]":"text-[#9AA0A8] hover:text-[#0B3D4A]"}
                `,children:[s.jsx(h,{className:`w-6 h-6 ${m?"stroke-[2.5]":"stroke-2"}`}),s.jsx("span",{className:`text-xs ${m?"font-semibold":"font-normal"}`,children:p}),m&&s.jsx("div",{className:"absolute bottom-0 w-8 h-1 bg-[#4AB7A5] rounded-full"})]},n)})})})})}const Rt=i.lazy(()=>v(()=>import("./AdminPanel-BZFFnKwy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]))),$t=i.lazy(()=>v(()=>import("./OperatorPanel-mHP4zKrz.js"),__vite__mapDeps([16,1,2,3,4,5,6,11,7,8,9,17,12,13,15]))),kt=i.lazy(()=>v(()=>import("./DashboardPage-CnCHBoz7.js"),__vite__mapDeps([18,1,2,3,4,5,9,15]))),Pt=i.lazy(()=>v(()=>import("./TopUpPage-TYjv8a08.js"),__vite__mapDeps([19,1,2,3,4,5,6,11,10,9,15]))),Ot=i.lazy(()=>v(()=>import("./PayPage-Wo8f9hdt.js"),__vite__mapDeps([20,1,2,3,4,5,6,17,9,15]))),Ft=i.lazy(()=>v(()=>import("./HistoryPage-C03dUUtV.js"),__vite__mapDeps([21,1,2,3,4,5,13,7,9,15]))),_t=i.lazy(()=>v(()=>import("./RequestDetailPage-D9ulRrkR.js"),__vite__mapDeps([22,1,2,3,4,5,13,9,15]))),Ct=i.lazy(()=>v(()=>import("./InstructionsPage-CFGO8lRA.js"),__vite__mapDeps([23,1,2,3,4,5,9,15]))),Dt=i.lazy(()=>v(()=>import("./SettingsPage-DyPAnyyJ.js"),__vite__mapDeps([24,1,2,3,4,5,8,9,13,14,6,15]))),$=()=>s.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:s.jsxs("div",{className:"text-center space-y-6",children:[s.jsxs("div",{className:"relative inline-block",children:[s.jsx("div",{className:"w-20 h-20 border-4 border-primary border-t-transparent rounded-full animate-spin"}),s.jsx(je,{className:"w-10 h-10 text-primary absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"})]}),s.jsx("h2",{className:"text-2xl font-black uppercase tracking-tight",children:"Загрузка..."})]})});function Bt(){const[t,e]=i.useState("home"),[o,r]=i.useState("dashboard"),[n,p]=i.useState("list"),[h,m]=i.useState(0),[j,x]=i.useState(0),[T,b]=i.useState(90),[O,N]=i.useState([]),[re,S]=i.useState([]),[se,Ne]=i.useState(null),[Re,ne]=i.useState(null),[ae,F]=i.useState(null),[w,U]=i.useState(null),[ie,z]=i.useState(""),[$e,q]=i.useState(""),[ce,_]=i.useState(""),[ke,L]=i.useState(""),[V,Pe]=i.useState(!0),C=i.useRef(null),[Oe,J]=i.useState(null),[Fe,H]=i.useState(0),[_e,M]=i.useState(0),[Ce,G]=i.useState(null),De=window.location.pathname==="/admin",Be=window.location.pathname==="/operator",k=async(l,c)=>{try{const[u,a]=await Promise.all([bt(l),At(l)]),g=u.map(y=>({...y,type:"payment"})),D=c||T||80,d=a.map(y=>({id:y.id,type:"deposit",amountRub:y.amount*D,amountUsdt:y.amount,status:y.status==="confirmed"?"paid":y.status,createdAt:y.createdAt,txHash:y.txHash,confirmedAt:y.confirmedAt,payableAmount:y.payableAmount?parseFloat(y.payableAmount):void 0,expiresAt:y.expiresAt,requestedAmount:y.requestedAmount?parseFloat(y.requestedAmount):void 0,walletAddress:y.walletAddress})),E=[...g,...d].sort((y,Q)=>new Date(Q.createdAt).getTime()-new Date(y.createdAt).getTime());N(E)}catch(u){console.error("Failed to load transactions:",u)}};i.useEffect(()=>{(async()=>{var c,u;if(typeof window<"u"&&((c=window.Telegram)!=null&&c.WebApp)){const a=window.Telegram.WebApp;a.ready(),a.expand(),a.disableVerticalSwipes&&a.disableVerticalSwipes(),a.setHeaderColor&&a.setHeaderColor("bg_color"),a.setBackgroundColor&&a.setBackgroundColor("bg_color");const g=(u=a.initDataUnsafe)==null?void 0:u.user,D=a.initData;if(g&&D)try{const d=await te(g.id,g.username||g.first_name||`user_${g.id}`,D);U(d.id),z(d.username),L(d.registeredAt),m(d.availableBalance),x(d.frozenBalance);let E="";if(d.fullName&&d.fullName.trim())E=d.fullName;else{const y=g.first_name||"",Q=g.last_name||"";E=[y,Q].filter(Boolean).join(" ")||g.username||d.username||"Пользователь"}q(E),d.avatarUrl?_(d.avatarUrl):g.photo_url&&_(g.photo_url),"referrerId"in d&&J(d.referrerId||null),"signupBonusActive"in d&&H(d.signupBonusActive||0),"signupBonusAmount"in d&&M(parseFloat(d.signupBonusAmount)||0),"signupBonusExpiresAt"in d&&G(d.signupBonusExpiresAt||null),await Promise.all([k(d.id),R(d.id).then(y=>S(y))])}catch(d){console.error("Failed to authenticate:",d)}else{console.log("Running outside Telegram, using demo mode");try{const d=await te(12345,"demo_user");U(d.id),z(d.username),L(d.registeredAt),m(d.availableBalance),x(d.frozenBalance),q(d.fullName||d.username),_(d.avatarUrl||""),"referrerId"in d&&J(d.referrerId||null),"signupBonusActive"in d&&H(d.signupBonusActive||0),"signupBonusAmount"in d&&M(parseFloat(d.signupBonusAmount)||0),"signupBonusExpiresAt"in d&&G(d.signupBonusExpiresAt||null),await Promise.all([k(d.id),R(d.id).then(E=>S(E))])}catch(d){console.error("Failed to initialize demo mode:",d)}}}else{console.log("Telegram WebApp not available, using demo mode");try{const a=await te(12345,"demo_user");U(a.id),z(a.username),L(a.registeredAt),m(a.availableBalance),x(a.frozenBalance),q(a.fullName||a.username),_(a.avatarUrl||""),"referrerId"in a&&J(a.referrerId||null),"signupBonusActive"in a&&H(a.signupBonusActive||0),"signupBonusAmount"in a&&M(parseFloat(a.signupBonusAmount)||0),"signupBonusExpiresAt"in a&&G(a.signupBonusExpiresAt||null),await Promise.all([k(a.id),R(a.id).then(g=>S(g))])}catch(a){console.error("Failed to initialize:",a)}}Pe(!1)})()},[]),i.useEffect(()=>{const l=async()=>{try{const u=await Et();u&&b(u.rate)}catch(u){console.error("Failed to fetch exchange rate:",{message:u instanceof Error?u.message:String(u),stack:u instanceof Error?u.stack:void 0,error:u})}};l();const c=setInterval(l,5e3);return()=>clearInterval(c)},[]),i.useEffect(()=>{if(!w)return;const c=setInterval(async()=>{try{const u=await oe(w);u&&(m(u.availableBalance),x(u.frozenBalance))}catch(u){console.error("Failed to refresh balance:",{message:u instanceof Error?u.message:String(u),stack:u instanceof Error?u.stack:void 0,userId:w,error:u})}},1e4);return()=>clearInterval(c)},[w]);const Ie=async l=>{if(w){m(c=>c+l);try{const c=await oe(w);c&&(m(c.availableBalance),x(c.frozenBalance))}catch(c){console.error("Failed to refresh balance:",c)}}},Ue=async l=>{if(!w){console.error("Payment submit failed: userId is missing"),alert("Не удалось создать заявку. Попробуйте снова.");return}try{const c={userId:w,amountRub:l.amountRub,amountUsdt:l.amountUsdt,frozenRate:l.frozenRate,urgency:l.urgency,attachments:l.attachments,comment:l.comment};console.log("Creating payment request with data:",{userId:w,amountRub:l.amountRub,amountUsdt:l.amountUsdt,frozenRate:l.frozenRate,urgency:l.urgency,attachmentsCount:l.attachments.length,attachmentsTypes:l.attachments.map(a=>{var g;return{type:a.type,hasValue:!!a.value,valueLength:(g=a.value)==null?void 0:g.length}}),comment:l.comment});const u=await vt(c);console.log("Payment request created successfully:",u),N(a=>[u,...a]),m(a=>a-l.amountUsdt),x(a=>a+l.amountUsdt),F(null),r("dashboard");try{const a=await R(w);S(a)}catch(a){console.error("Failed to refresh notifications after payment creation:",a)}}catch(c){console.error("Failed to create payment request - Detailed error:",c),console.error("Error type:",c instanceof Error?c.constructor.name:typeof c),console.error("Error message:",c instanceof Error?c.message:String(c)),console.error("Error stack:",c instanceof Error?c.stack:"No stack trace"),c instanceof Error?alert(`Не удалось создать заявку. Ошибка: ${c.message}`):alert("Не удалось создать заявку. Попробуйте снова.")}},ze=async l=>{try{if(await Tt(l,"cancelled"),N(c=>c.map(u=>{if(u.id===l){const a=u.usdtFrozen||0;return m(g=>g+a),x(g=>g-a),{...u,status:"cancelled"}}return u})),w){const c=await R(w);S(c)}}catch(c){console.error("Failed to cancel request:",c)}},qe=async()=>{confirm("Вы уверены, что хотите очистить все тестовые данные? Это действие нельзя отменить.")&&(N([]),S([]),F(null),console.log("Данные очищены (только локально в тестовом режиме)"))},Le=l=>{e(l),l==="history"&&p("list"),l==="home"&&r("dashboard")};i.useEffect(()=>{if(!w||C.current===t)return;if(C.current===null&&V){C.current=t;return}(async()=>{try{if(t==="home"){const c=await oe(w);c&&(m(c.availableBalance),x(c.frozenBalance))}else if(t==="history")await k(w,T);else if(t==="settings"){const c=await R(w);S(c)}}catch(c){console.error("Failed to refresh data on tab change:",c)}})(),C.current=t},[t,w,T,V]);const Ve=()=>{e("home"),r("dashboard"),F(null)},Je=l=>{Ne(l),p("detail")},He=l=>{ne(l),e("home"),r("topup")},Me=async()=>{if(w)try{await k(w,T)}catch(l){console.error("Failed to refresh transactions:",l)}},Ge=async l=>{try{await St(l),S(c=>c.map(u=>u.id===l?{...u,isRead:!0}:u))}catch(c){console.error("Failed to mark notification as read:",c)}},le=se?O.find(l=>l.id===se):null;return De?s.jsx(W,{client:Z,children:s.jsxs(ee,{children:[s.jsx(i.Suspense,{fallback:s.jsx($,{}),children:s.jsx(Rt,{})}),s.jsx(Y,{})]})}):Be?s.jsx(W,{client:Z,children:s.jsxs(ee,{children:[s.jsx(i.Suspense,{fallback:s.jsx($,{}),children:s.jsx($t,{})}),s.jsx(Y,{})]})}):V?s.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:s.jsxs("div",{className:"text-center space-y-6",children:[s.jsxs("div",{className:"relative inline-block",children:[s.jsx("div",{className:"w-20 h-20 border-4 border-primary border-t-transparent rounded-full animate-spin"}),s.jsx(je,{className:"w-10 h-10 text-primary absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"})]}),s.jsx("h2",{className:"text-2xl font-black uppercase tracking-tight",children:"Загрузка..."}),s.jsx("p",{className:"text-sm text-muted-foreground font-medium",children:"Подключение к серверу"})]})}):s.jsx(W,{client:Z,children:s.jsx(ee,{children:s.jsxs("div",{className:"min-h-screen bg-background",children:[t==="home"&&s.jsxs(i.Suspense,{fallback:s.jsx($,{}),children:[o==="dashboard"&&s.jsx(kt,{availableUsdt:h,frozenUsdt:j,exchangeRate:T,onTopUp:()=>r("topup"),onPay:()=>{r("pay")},hasDraft:ae!==null,username:ie,fullName:$e,avatarUrl:ce,signupBonusActive:Fe,signupBonusAmount:_e,signupBonusExpiresAt:Ce}),o==="topup"&&s.jsx(Pt,{userId:w||void 0,depositId:Re||void 0,onBack:()=>{r("dashboard"),ne(null)},onTopUpComplete:Ie,onNavigateToHistory:()=>{e("history"),p("list")}}),o==="pay"&&s.jsx(Ot,{exchangeRate:T,availableUsdt:h,onBack:()=>{r("dashboard")},onSubmit:Ue,draft:ae,onDraftChange:F})]}),t==="history"&&s.jsxs(i.Suspense,{fallback:s.jsx($,{}),children:[n==="list"&&s.jsx(Ft,{transactions:O,onGoHome:Ve,onViewRequest:Je,onOpenDeposit:He,onRefresh:Me}),n==="detail"&&le&&s.jsx(_t,{request:le,onBack:()=>p("list"),onCancelRequest:ze})]}),t==="instructions"&&s.jsx(i.Suspense,{fallback:s.jsx($,{}),children:s.jsx(Ct,{})}),t==="settings"&&s.jsx(i.Suspense,{fallback:s.jsx($,{}),children:s.jsx(Dt,{username:ie,registeredAt:ke,notifications:re,onClearData:qe,onMarkNotificationRead:Ge,userId:w,referrerId:Oe,avatarUrl:ce})}),s.jsx(Nt,{activeTab:t,onTabChange:Le,unreadCount:re.filter(l=>!l.isRead).length}),s.jsx(Y,{})]})})})}be(document.getElementById("root")).render(s.jsx(Bt,{}));export{At as A,eo as B,to as C,yo as D,wo as E,go as F,io as a,xo as b,A as c,Jt as d,Ht as e,Mt as f,fo as g,Gt as h,Qt as i,Wt as j,Zt as k,oo as l,ro as m,Xt as n,Kt as o,Yt as p,so as q,ao as r,no as s,po as t,ht as u,mo as v,ho as w,co as x,lo as y,uo as z};
